(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{290:function(e,t,a){"use strict";a.r(t);var s=a(14),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"truenas-zfs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#truenas-zfs"}},[e._v("#")]),e._v(" truenas（ZFS）")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/681227299",target:"_blank",rel:"noopener noreferrer"}},[e._v("hyper-v运行truenas记录。"),a("OutboundLink")],1)]),e._v(" "),a("p",[a("strong",[e._v("固态硬盘的外置缓存")])]),e._v(" "),a("p",[e._v("可以一力降十会，FTL表，Bitmap表会更宽裕，GC触发更少，GC算法效率好得多，理论寿命更长。"),a("strong",[e._v("带外置缓存的固态最重要的是更低的售后期望。")])]),e._v(" "),a("p",[a("strong",[e._v("副厂固态硬盘")])]),e._v(" "),a("p",[e._v("正片颗粒暴毙概率很小。白片颗粒有较小概率暴毙，而拆机片，黑片，暴毙概率很大。")]),e._v(" "),a("p",[e._v("只要不是颗粒暴毙，即使出现掉盘，健康度下降，一般只要不误操作，并如后文所述做好擦洗，数据完全损失概率较小。")]),e._v(" "),a("p",[e._v("如梵想，移速，海康，七彩虹，朗科，达墨，金士顿，acer宏碁等贴牌，代工厂自有品牌如阿斯加特，光威，金百达，江波龙雷克沙。")]),e._v(" "),a("p",[e._v("除了白片，还会混有拆机片，黑片。存在送测或前几批用好一点的颗粒，之后图穷匕见的现象。这几个牌子我估计就阿斯加特跟雷克沙因为定位相对高一点，可能会好一点。")]),e._v(" "),a("blockquote",[a("p",[e._v("截止23年8月，说自己是长江颗粒的好赖是白片。")])]),e._v(" "),a("p",[e._v("副厂盘除了文件静默损坏概率大，还有可能读冷数据需要纠错，导致速度变慢，系统盘会导致系统响应很慢。")]),e._v(" "),a("h2",{attrs:{id:"固态硬盘必将取代机械硬盘"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#固态硬盘必将取代机械硬盘"}},[e._v("#")]),e._v(" 固态硬盘必将取代机械硬盘")]),e._v(" "),a("p",[e._v("23年8月长江白片（既第三方封装厂封装的自封片）TLC颗粒消费者能买到的价格约200/TB，假如是QLC白片，价格打8折，那就是160/TB。消费者常买的hc550等机械硬盘，基本在100~130/TB左右。")]),e._v(" "),a("p",[e._v("电子产品价格本质是有多少人摊销，随着机械硬盘不断减产，此消彼长之下，NAS全面换装固态硬盘的时代应该不远了，固态硬盘静音，体积小，优点相当多。")]),e._v(" "),a("blockquote",[a("p",[e._v("中国将依托闪存弯道超车替代机械硬盘，中国人就应该买长江存储颗粒的固态硬盘。")])]),e._v(" "),a("h3",{attrs:{id:"文件静默损坏"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件静默损坏"}},[e._v("#")]),e._v(" 文件静默损坏")]),e._v(" "),a("p",[e._v("固态硬盘出现坏块的概率远高于机械硬盘，从健康度（有多少坏块被备用块替换）就可见一斑。")]),e._v(" "),a("ul",[a("li",[e._v("机械硬盘在其寿命周期内，健康度很少下降，一旦下降，较大概率将“传染”。")]),e._v(" "),a("li",[e._v("固态硬盘的健康度下降贯穿其整个寿命周期，主控也需要强劲的ECC纠错能力。")])]),e._v(" "),a("p",[e._v("健康度下降是坏块被备用块替换的正常现象，直觉上只要备用块没用光就没事，但是主控要读取才知道好坏，而纠错能力有上限，超出就会有所谓“文件静默损坏”。用于存储会有大量冷数据处于如好状态，出现静默损坏的概率大增。")]),e._v(" "),a("h4",{attrs:{id:"解决静默损坏-定期数据擦洗-scrub"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决静默损坏-定期数据擦洗-scrub"}},[e._v("#")]),e._v(" 解决静默损坏：定期数据擦洗（scrub）")]),e._v(" "),a("p",[e._v("定期擦洗校验可以避免文件静默损坏，只要读取过，主控就会替换坏块。")]),e._v(" "),a("p",[e._v("ReFS（win），BTRFS，ZFS，XFS（Linux 5.19+），Bcachefs等文件系统支持数据擦洗。软raid1下，只有磁盘主控报错，才能确定哪份文件是坏的，极端情况下没有校验无法确认哪份镜像是好文件，甚至write hole，而定期擦洗可以保证文件一致性。")]),e._v(" "),a("blockquote",[a("p",[e._v("ext4或ntfs可以全盘计算CRC32来预热冷数据。")]),e._v(" "),a("p",[e._v("ReFS叫完整性流是可选功能，"),a("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/windows-server/storage/refs/integrity-streams",target:"_blank",rel:"noopener noreferrer"}},[e._v("需要自行开启"),a("OutboundLink")],1),e._v("。")])]),e._v(" "),a("ul",[a("li",[a("p",[e._v("btrfs更灵活，但名声不佳，作为单盘文件系统的稳定性还可以。目前btrfs的部分前开发者转进到xfs。")])]),e._v(" "),a("li",[a("p",[e._v("Bcachefs发布时间不长，可靠性有待验证。")])]),e._v(" "),a("li",[a("p",[e._v("xfs（Linux 5.19+）导入擦洗特性时间较短。")])]),e._v(" "),a("li",[a("p",[e._v("zfs灵活性差，一旦出现错误并导致无法挂载的时候，没有方便实用的工具尝试修复，往往只能尝试强制挂载，不排除导致彻底损毁的可能。zfs推荐至少3分之一的校验盘，既2+1；4+2；6+3；")])]),e._v(" "),a("li",[a("p",[e._v("9盘以上，ceph。")])])]),e._v(" "),a("p",[e._v("必须要"),a("strong",[e._v("定期擦洗")]),e._v("，才会发挥功能，**不用就是摆设！**还不如ext4，NTFS稳定！")]),e._v(" "),a("h4",{attrs:{id:"破除机械硬盘可靠性更高的幻境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#破除机械硬盘可靠性更高的幻境"}},[e._v("#")]),e._v(" 破除机械硬盘可靠性更高的幻境")]),e._v(" "),a("p",[e._v("固态硬盘ECC纠错性能强得多，只要如后文所述定期擦洗数据，基本不会有数据损失。而机械硬盘的健康度“下降预警”几乎一定伴随着数据损失。")]),e._v(" "),a("p",[e._v("常用的12T及以上大小机械硬盘通常是加密的，所谓的可恢复性往往是海市哲楼，即使是能恢复的硬盘也要价不菲。")]),e._v(" "),a("h3",{attrs:{id:"离线移动固态硬盘不适合用于备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#离线移动固态硬盘不适合用于备份"}},[e._v("#")]),e._v(" 离线移动固态硬盘不适合用于备份")]),e._v(" "),a("p",[e._v("从固态硬盘的特性来看，更适合作为大号u盘，进行临时性的文件转移，不适合用于备份。更不要说固态硬盘需要进行GC，TRIM等操作。")]),e._v(" "),a("p",[e._v("因此有一个算一个，所有的移动固态硬盘，移动固态硬盘盒产品都是对用户数据极端不负责任。三星，WD闪迪，铠侠热衷于推出此类产品，巴不得用户遇到数据丢失的灾难。")]),e._v(" "),a("p",[e._v("已经爆发血的教训："),a("a",{attrs:{href:"http://www.ithome.com/0/711/776.htm",target:"_blank",rel:"noopener noreferrer"}},[e._v("WD闪迪Extreme移动固态硬盘大面积故障"),a("OutboundLink")],1),e._v("，更令人震惊的是，借着解决问题为由，推送新固件扩大战果，WD闪迪牢记使命——以破坏用户数据为己任。")]),e._v(" "),a("h2",{attrs:{id:"zfs-refs不是万能的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zfs-refs不是万能的"}},[e._v("#")]),e._v(" ZFS，ReFS不是万能的")]),e._v(" "),a("p",[e._v("ZFS与ReFS等新文件系统更多的只是提供了新特性，并不是说他们的安全性有多么强大，不使用他们提供的擦洗功能，其安全性相对ext4，NTFS并没有显著的提升。")]),e._v(" "),a("p",[e._v("ZFS要勤建快照，极端情况下掉电，有可能导致文件全部损毁，有快照至少能回退到快照。")]),e._v(" "),a("h2",{attrs:{id:"zfs与ecc内存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zfs与ecc内存"}},[e._v("#")]),e._v(" zfs与ecc内存")]),e._v(" "),a("p",[e._v("zfs开发者Matt Ahrens表示，zfs由内存位翻转引起文件损坏的风险与其他任何文件系统无异。"),a("a",{attrs:{href:"https://www.bilibili.com/video/BV1AW4y1y796/?vd_source=0f979343d8d80457d46c0d412b440d06",target:"_blank",rel:"noopener noreferrer"}},[e._v("根据网友实测分享"),a("OutboundLink")],1),e._v("，内存位翻转的概率非常低，往往需要重负载。")]),e._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://arstechnica.com/civis/threads/ars-walkthrough-using-the-zfs-next-gen-filesystem-on-linux.1235679/page-4#posts",target:"_blank",rel:"noopener noreferrer"}},[e._v("Matt Ahrens回答"),a("OutboundLink")],1),e._v("： There's nothing special about ZFS that requires/encourages the use of ECC RAM more so than any other filesystem. If you use UFS, EXT, NTFS, btrfs, etc without ECC RAM, you are just as much at risk as if you used ZFS without ECC RAM. Actually, ZFS can mitigate this risk to some degree if you enable the unsupported ZFS_DEBUG_MODIFY flag (zfs_flags=0x10). This will checksum the data while at rest in memory, and verify it before writing to disk, thus reducing the window of vulnerability from a memory error. I would simply say: if you love your data, use ECC RAM. Additionally, use a filesystem that checksums your data, such as ZFS.")])]),e._v(" "),a("p",[e._v("极端情况下，正在写入的文件，遇到位翻转并错误写入，文件系统是无法校验发现的。在写入时我会使用rsync或fastcopy/teracopy写入后校验，归档rar内嵌恢复记录。")]),e._v(" "),a("blockquote",[a("p",[e._v("100mb的压缩文件，10%恢复记录一般最多修复5mb的文件损坏，实际往往更小。")])]),e._v(" "),a("h2",{attrs:{id:"nas厂货"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nas厂货"}},[e._v("#")]),e._v(" NAS厂货")]),e._v(" "),a("p",[a("strong",[e._v("用到中转服务")])]),e._v(" "),a("p",[e._v("如果需要厂家的中转服务以实现外网访问，推荐华为NAS，好像默认是格式化成ext4，功能也很羸弱。")]),e._v(" "),a("p",[e._v("但目前只有华为的中转服务老用户满速，极空间绿联给新用户更高优先级，老用户高峰期慢的跟蜗牛爬一样。而群晖和威联通不清楚是带宽有限还是什么原因，速度实在算不上理想。")]),e._v(" "),a("p",[a("strong",[e._v("擦洗特性")])]),e._v(" "),a("p",[e._v("群晖提供lvm+简化版单盘btrfs，拆下来要用老版本的linux才能挂载。")]),e._v(" "),a("p",[e._v("威联通能装quts hero用ZFS，一般都是能用ecc内存的x86方案才能装，但是不标配ecc内存。")]),e._v(" "),a("blockquote",[a("p",[e._v("绿联，极空间本质上还是攒电脑。你要说zfs复杂度高不灵活，btrfs,Bcachefs可能不稳定，但至少可以适配xfs提供擦洗。")])]),e._v(" "),a("h2",{attrs:{id:"群晖用zfs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#群晖用zfs"}},[e._v("#")]),e._v(" 群晖用ZFS")]),e._v(" "),a("h3",{attrs:{id:"truenas安装与配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#truenas安装与配置"}},[e._v("#")]),e._v(" truenas安装与配置")]),e._v(" "),a("p",[e._v("truenas与freenas合并，分为两个版本，core基于freebsd，SCALE则基于debian，有docker，虚拟机。")]),e._v(" "),a("p",[e._v("truenas官网下载系统镜像后"),a("a",{attrs:{href:"https://link.zhihu.com/?target=https%3A//rufus.ie/zh/",target:"_blank",rel:"noopener noreferrer"}},[e._v("rufus"),a("OutboundLink")],1),e._v("写入u盘，u盘启动安装。默认情况下系统盘的剩余空间是无法被利用的。")]),e._v(" "),a("p",[e._v("修改网页端语言时区：System→General→Localization Settings")]),e._v(" "),a("ul",[a("li",[e._v("Language:Simplified Chinese")]),e._v(" "),a("li",[e._v("Timezone:Asia/Shanghai")])]),e._v(" "),a("p",[e._v("存储-创建池，把左边列表的空闲硬盘选中，按向右箭头即设置为准备建池的硬盘。")]),e._v(" "),a("ul",[a("li",[e._v("条带类似于RAID-0，速度快，但是坏一块硬盘数据全掉。")]),e._v(" "),a("li",[e._v("镜像类似于RAID-1，镜像备份，支持多块硬盘。")]),e._v(" "),a("li",[e._v("RAID-Zx，数字x即为冗余校验盘的数量，zfs推荐至少三分之一。")])]),e._v(" "),a("p",[e._v("本例新建镜像-起名为jingxiang1。")]),e._v(" "),a("p",[e._v("之后切换到数据集。")]),e._v(" "),a("ul",[a("li",[e._v("Zvol类似于虚拟磁盘，可以挂载到虚拟机格式化为ext4等文件系统")]),e._v(" "),a("li",[e._v("数据集类似于新建文件夹。")])]),e._v(" "),a("p",[e._v("新建名叫zdsm的数据集，ACL类型：SMB/NFSv4，压缩等级：ZSTD，其余默认。")]),e._v(" "),a("blockquote",[a("p",[e._v("zstd压缩性能不俗，速度也快。不加数字后缀则压缩等级为3，fast为1，根据现有测试来看，增大压缩等级对读取影响较小，但是写入速度影响较大，对cpu占用非常大。所以一般默认的3比较折中，和1速度差不多，但是压缩性能强一些。如果cpu性能很弱，可以考虑改为zstd-fast。")])]),e._v(" "),a("p",[e._v("证书-本地用户-添加，新建用于读写smb共享的用户，只需要填全名，用户名，密码，uid和组会自动生成。本例用户名为ceshi。")]),e._v(" "),a("p",[e._v("对zdsm数据集的权限修改，用户和用户组改为ceshi，修改需要勾选应用于用户/组。")]),e._v(" "),a("p",[e._v("切换到共享-添加SMB共享，路径为上文建立的数据集，/mnt/jingxiang1/zdsm。名称可自定义，本例为zdsm，既smb访问路径为\\192.168.3.31\\zdsm。windows下资源管理器输入该地址既可直接访问测试。")]),e._v(" "),a("blockquote",[a("p",[e._v("192.168.3.31是我的truenas的地址，请根据实际修改。")])]),e._v(" "),a("h3",{attrs:{id:"虚拟机安装黑群晖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#虚拟机安装黑群晖"}},[e._v("#")]),e._v(" 虚拟机安装黑群晖")]),e._v(" "),a("p",[e._v("GXNAS编译的"),a("a",{attrs:{href:"https://wp.gxnas.com/11849.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("引导文件下载"),a("OutboundLink")],1),e._v("，也可以参考其编译教程"),a("a",{attrs:{href:"https://wp.gxnas.com/12245.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("1"),a("OutboundLink")],1),e._v("，"),a("a",{attrs:{href:"https://wp.gxnas.com/11358.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("2"),a("OutboundLink")],1),e._v("。")]),e._v(" "),a("p",[e._v("本例为其编译的DS3622_7.2-64570（引导文件）.img，在"),a("a",{attrs:{href:"https://www.synology.cn/zh-cn/support/download/DS3622xs+?version=7.2#system",target:"_blank",rel:"noopener noreferrer"}},[e._v("群晖官网"),a("OutboundLink")],1),e._v("下载引导对应版本的DSM系统文件。本例为DSM_DS3622xs+_64570.pat。")]),e._v(" "),a("ul",[a("li",[e._v("truenas虚拟机")])]),e._v(" "),a("p",[e._v("将DS3622_7.2-64570.img拷贝到truenas中的/mnt/jingxiang1/zdsm，通过上文的smb共享。")]),e._v(" "),a("p",[e._v("数据集新建Zvol，起名dsmboot，容量2GiB，新建DSM1，容量21GiB。将引导写入虚拟磁盘dsmboot：")]),e._v(" "),a("blockquote",[a("p",[e._v("21gb是安装群晖的最小容量，群晖系统占用10g左右，新建存储池至少10g。")])]),e._v(" "),a("p",[e._v("在truenas的系统设置-命令行运行，网页端shell粘贴按shift+insert（delete上方的键）")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("sudo dd if=/mnt/jingxiang1/zdsm/DS3622_7.2-64570.img of=/dev/jingxiang1/dsmboot\n")])])]),a("p",[e._v("cpu和内存看着给，之后跳转到修改网络配置，truenas下默认桥接不用修改。")]),e._v(" "),a("ul",[a("li",[e._v("windows宿主机VirtualBox虚拟机")])]),e._v(" "),a("p",[e._v("windows需要cmd定位到DS3622_7.2-64570.img所在目录，转换.img为虚拟磁盘.vdi。vmwork可以用starwind v2v converter工具转换。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('"C:\\Program Files\\Oracle\\VirtualBox\\VBoxManage.exe" convertfromraw DS3622_7.2-64570.img dsmboot.vdi --format VDI\n')])])]),a("p",[e._v("新建虚拟机linux2.6,3.x,4.x,5.x(64bit)，cpu和内存看着给。先不添加虚拟硬盘。创建后右键虚拟机，设置，存储，sata下新增磁盘，注册转换得到的dsmboot.vdi。再创建新的虚拟磁盘，磁盘容量至少21g。")]),e._v(" "),a("blockquote",[a("p",[e._v("21gb是安装群晖的最小容量，群晖系统占用10g左右，新建存储池至少10g。")])]),e._v(" "),a("ul",[a("li",[e._v("修改网络配置")])]),e._v(" "),a("p",[e._v("网络改为桥接网卡，修改mac地址：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("001132123456\n00:11:32:12:34:56\n")])])]),a("blockquote",[a("p",[e._v("mac地址匹配.img中的配置，此为GXNAS分享的预设。")]),e._v(" "),a("p",[e._v("桥接网卡列表没有物理网卡，win+q搜索网络连接，查看网络连接（控制面板）-右键物理网卡， 属性中启用VirtualBox NDIS6 Bridged Networking Driver服务，如果没有则安装-服务-从磁盘安装，定位到C:\\Program Files\\Oracle\\VirtualBox\\drivers\\network\\netlwf文件夹。")])]),e._v(" "),a("p",[e._v("启动后在路由器后台查看是否上线，或群晖助手搜索。网页打开其内网ip，安装前文下载的.pat文件。")]),e._v(" "),a("blockquote",[a("p",[e._v("显示上线，但是无法连接，检查引导参数配置是否匹配，如网卡mac地址等。")])]),e._v(" "),a("h3",{attrs:{id:"黑群晖挂载zfs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#黑群晖挂载zfs"}},[e._v("#")]),e._v(" 黑群晖挂载ZFS")]),e._v(" "),a("p",[e._v("本例群晖中用户名为ceshi2")]),e._v(" "),a("p",[e._v("方法0：黑群晖自由发挥，hyper backup套件备份到TrueNAS，还能备份相册数据。")]),e._v(" "),a("p",[e._v("方法1：truenas安装虚拟机zvol虚拟磁盘挂载到群晖。")]),e._v(" "),a("p",[e._v("方法2：通过smb（cifs）挂载，只有手机同步jpeg能工作，其他方法或格式无法建立缩略图卡住转圈。")]),e._v(" "),a("blockquote",[a("p",[e._v("dsm7.2 群晖photos 1.5 truenas 22.12.3.3。")])]),e._v(" "),a("p",[e._v("群晖开启家目录后，管理员用户能看到/volume1/homes/ceshi2既为登录ceshi2用户后的/home。而Synology Photos照片同步在/volume1/homes/ceshi2/Photos/MobileBackup。")]),e._v(" "),a("p",[e._v("运行file station，工具-装载远程文件夹-CIFS，文件夹为//192.168.3.31/zdsm，账号密码既truenas创建的用户密码。挂载为/volume1/homes/ceshi2/Photos。")]),e._v(" "),a("blockquote",[a("p",[e._v("群晖的挂载只让挂载二级目录，/volume1/homes/ceshi2由于是ceshi2的/home也不行。")])]),e._v(" "),a("p",[e._v("方法2.1:在终端机开启ssh，ssh登录到群晖，本例使用"),a("a",{attrs:{href:"https://mobaxterm.mobatek.net/",target:"_blank",rel:"noopener noreferrer"}},[e._v("MobaXterm"),a("OutboundLink")],1),e._v("软件。")]),e._v(" "),a("p",[e._v("这样挂载打开filestation会提示错误，缩略图故障依旧。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("#smb\nsudo mount -t cifs -o vers=3.0,username=ceshi,password=ceshiceshi //192.168.3.31/zdsm /volume1/homes/ceshi2\n#nfs\nsudo mount -t nfs 192.168.3.31:/mnt/jingxiang1/zdsm /volume1/homes/ceshi2\n\n#卸载\numount /volume1/homes/ceshi2\n")])])]),a("p",[e._v("不开启家目录则相册套件会生成/volume1/photo目录，同步在/volume1/photo/MobileBackup。可以用群晖挂载MobileBackup，或mount挂载photo目录。")]),e._v(" "),a("blockquote",[a("p",[e._v("网友@"),a("a",{attrs:{href:"https://www.zhihu.com/people/0eca5c55343af4c6959c22b0b682de7d",target:"_blank",rel:"noopener noreferrer"}},[e._v("dmx"),a("OutboundLink")],1),e._v("分享解决略缩图生成解决方法：")]),e._v(" "),a("p",[e._v("关于通过CIFS挂载smb目录不能生成缩略图的问题，可以参考一下我的方案，我今天通过这个方案解决了：")]),e._v(" "),a("ol",[a("li",[e._v("挂载smb到home/Photos")]),e._v(" "),a("li",[e._v("想办法激活ame（网上要求需要半洗白，不清楚不洗白是否可以，未尝试用）")]),e._v(" "),a("li",[e._v("开启 SYNOFSIsRemoteFS")])]),e._v(" "),a("p",[e._v("DMS7：")]),e._v(" "),a("p",[e._v("sudo -i")]),e._v(" "),a("p",[e._v("wget "),a("a",{attrs:{href:"http://link.zhihu.com/?target=http%3A//code.imnks.com/face/PatchELFSharp",target:"_blank",rel:"noopener noreferrer"}},[e._v("code.imnks.com/face/Pat"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("chmod +x PatchELFSharp")]),e._v(" "),a("p",[e._v('./PatchELFSharp "/usr/lib/libsynosdk.so.7" "SYNOFSIsRemoteFS" "B8 00 00 00 00 C3"')]),e._v(" "),a("p",[e._v("DSM7恢复：")]),e._v(" "),a("p",[e._v("cp -f /usr/lib/libsynosdk.so.7.bak /usr/lib/libsynosdk.so.7")]),e._v(" "),a("p",[e._v("rm -f /usr/lib/libsynosdk.so.7.bak")]),e._v(" "),a("p",[e._v("DMS6：")]),e._v(" "),a("p",[e._v("sudo -i")]),e._v(" "),a("p",[e._v("wget "),a("a",{attrs:{href:"http://link.zhihu.com/?target=http%3A//code.imnks.com/face/PatchELFSharp",target:"_blank",rel:"noopener noreferrer"}},[e._v("code.imnks.com/face/Pat"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("chmod +x PatchELFSharp")]),e._v(" "),a("p",[e._v('./PatchELFSharp "/usr/lib/libsynosdk.so.6" "SYNOFSIsRemoteFS" "B8 00 00 00 00 C3"')]),e._v(" "),a("p",[e._v("DSM6恢复：")]),e._v(" "),a("p",[e._v("cp -f /usr/lib/libsynosdk.so.6.bak /usr/lib/libsynosdk.so.6")]),e._v(" "),a("p",[e._v("rm -f /usr/lib/libsynosdk.so.6.bak")]),e._v(" "),a("p",[e._v("开启 SYNOFSIsRemoteFS的这个参考矿神的方案 "),a("a",{attrs:{href:"http://link.zhihu.com/?target=https%3A//imnks.com/6557.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("开启群晖套件访问NFS/CIFS远程目录（SMB/NFS挂载）功能"),a("OutboundLink")],1),e._v("，这一步是必须的。")]),e._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[e._v("如果还不行的话，尝试安装ffmpeg，并替换原来的ffmpeg。")])]),e._v(" "),a("p",[e._v("第二步和第三步是必须的，第四步不知道是不是必须的，没有尝试过。完成以后，删除@eaDir目录。然后重建索引，应该就可以生成缩略图了。")])]),e._v(" "),a("h2",{attrs:{id:"truenas使用docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#truenas使用docker"}},[e._v("#")]),e._v(" truenas使用docker")]),e._v(" "),a("h3",{attrs:{id:"truenas24-10变回docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#truenas24-10变回docker"}},[e._v("#")]),e._v(" truenas24.10变回docker")]),e._v(" "),a("p",[e._v("网页端安装应用跨栏或用docker镜像源，跨栏应用现在允许来自局域网的连接，防火墙添加允许bin文件夹下的exe文件。docker添加http代理即可。")]),e._v(" "),a("p",[e._v("truenas网页端-应用-选择池，会自动部署docker。")]),e._v(" "),a("blockquote",[a("p",[e._v("只有在网页端安装的才会在网页端显示，用docker命令行或portainer-ce创建的不会在TrueNas的webui显示。")])]),e._v(" "),a("p",[e._v("22.10的时候truenas网页端安装应用要将用于部署的数据集的用户和组设置为apps，docker命令部署则无所谓。不清楚24.10要不要。")]),e._v(" "),a("ul",[a("li",[e._v("修改docker镜像服务器")])]),e._v(" "),a("p",[e._v("truenas系统设置-服务启用ssh服务，"),a("a",{attrs:{href:"https://mobaxterm.mobatek.net/",target:"_blank",rel:"noopener noreferrer"}},[e._v("MobaXterm"),a("OutboundLink")],1),e._v("软件登录。")]),e._v(" "),a("p",[e._v("给docker添加镜像源：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('sudo vim /etc/docker/daemon.json\n按INS键切换成insert，最下面一行会有模式提示。\n添加：\n,"registry-mirrors":[XXX]\n现在镜像源失效的很快，自己搜最新的镜像源，注意前面加个逗号。\n之后按esc退出编辑模式，打:wq!回车，保存并退出。\n重启docker：\nsudo systemctl restart docker\n')])])]),a("p",[a("strong",[e._v("truenas 23.10")])]),e._v(" "),a("p",[a("strong",[e._v("没必要搞这么复杂，直接更新24.10。")])]),e._v(" "),a("p",[e._v("该版本没有内置docker-cli，"),a("a",{attrs:{href:"https://link.zhihu.com/?target=https%3A//github.com/Jip-Hop/jailmaker",target:"_blank",rel:"noopener noreferrer"}},[e._v("jailmaker"),a("OutboundLink")],1),e._v("脚本将安装systemd-nspawn运行一个debian容器，在这个容器中安装docker。")]),e._v(" "),a("p",[e._v("新建一个数据集，以/mnt/jingxiang1/docker为例。在truenas的webui中选中docker数据集，再新建数据集，就会成为docker的子集。本例新建了jailmaker，myjail，config，data。")]),e._v(" "),a("blockquote",[a("p",[e._v("jailmaker集用于放置**"),a("a",{attrs:{href:"https://link.zhihu.com/?target=https%3A//github.com/Jip-Hop/jailmaker",target:"_blank",rel:"noopener noreferrer"}},[e._v("jailmaker"),a("OutboundLink")],1),a("strong",[e._v("脚本与容器文件")]),e._v("。**myjail将挂载为容器内/home。")])]),e._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("cd /mnt/jingxiang1/docker/jailmaker\ncurl --location --remote-name https://raw.githubusercontent.com/Jip-Hop/jailmaker/main/jlmkr.py\n# 也可以自己下载该文件后拷贝进去。\nchmod +x jlmkr.py\n./jlmkr.py install #后来更新好像把install改成creat了。\n")])])]),a("p",[e._v("之后在webui的系统设置-高级-开关机脚本-添加，类型命令，初始化后期（"),a("em",[e._v("Post Init")]),e._v("）")]),e._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("/mnt/jingxiang1/docker/jailmaker/jlmkr.py startup\n")])])]),a("p",[e._v("之后运行jlmkr，一路y，直到")]),e._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("Would you like to add additional systemd-nspawn flags?\n设置挂载：\n--bind='/mnt/jingxiang1/docker/myjail:/home' \\\n--bind='/mnt/jingxiang1/docker/config:/mnt/config' \\\n--bind='/mnt/jingxiang1/docker/data:/mnt/data'\n")])])]),a("p",[e._v("建立myjail后，进入容器控制台并安装docker")]),e._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("sudo jlmkr shell myjail\ncurl -fsSL https://get.docker.com -o install-docker.sh\nsh install-docker.sh\n")])])]),a("h3",{attrs:{id:"部署portainer-ce"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署portainer-ce"}},[e._v("#")]),e._v(" 部署portainer-ce")]),e._v(" "),a("p",[e._v("管理docker的webui。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("sudo docker run -d  \\\n    --name portainer  \\\n    --network=host   \\\n    -v /var/run/docker.sock:/var/run/docker.sock   \\\n    -v /mnt/config/portainer_data:/data    \\\n    --restart=always \\\n    portainer/portainer-ce:latest\n\n#/mnt/jingxiang1/docker/portainer_data自行修改。\n#/var/run/docker.sock不要改。\n#不用host网络需要设置端口转发，9000用于http，9443用于https。\n#-p 8000:8000  -p 9000:9000 -p 9443:9443\n#--privileged 遇到问题可以试试，赋予主机root权限。一般不需要。\n")])])]),a("p",[e._v("docker部分指令：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("sudo docker ps 列出运行中容器，列出的第一列id用于后续操作。\nsudo docker stop id 停止容器\nsudo docker restart id 重启容器\nsudo docker rm id 删除容器\n")])])]),a("h3",{attrs:{id:"部署qbittorrent-ee"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署qbittorrent-ee"}},[e._v("#")]),e._v(" 部署qbittorrent-ee：")]),e._v(" "),a("p",[e._v("qbittorrent加强版，有一些优化。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("sudo docker run -d  \\\n    --name=qbittorrentee  \\\n    --network=host  \\\n    -e WEBUIPORT=8080  \\\n    -e PUID=3000 \\\n    -e PGID=3000 \\\n    -e TZ=Asia/Shanghai \\\n    -v /mnt/config/qbittorrent:/config  \\\n    -v /mnt/data/qbittorrent:/downloads  \\\n    --restart unless-stopped  \\\n    superng6/qbittorrentee:latest\n\n#puid，pgid在证书-本地用户查看，smb分享的时候能够用该账户登录处理文件。\n#/mnt/jingxiang1/docker/qbittorrent自行修改。\n#不用host网络需要设置端口转发，8080用于webui，6881用于bt监听，可以在qbittorrent设置里修改。\n#   -p 6881:6881  \\\n#   -p 6881:6881/udp  \\\n#   -p 8080:8080  \\ \n")])])]),a("h3",{attrs:{id:"部署smartdns"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署smartdns"}},[e._v("#")]),e._v(" 部署smartdns：")]),e._v(" "),a("p",[e._v("优选速度最快的dns结果，屏蔽广告dns。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("sudo docker run -d --name smartdns \\\n            --restart=always \\\n            --network=host  \\\n            -v /mnt/config/smartdns:/etc/smartdns \\\n            pymumu/smartdns:latest\n\n#不用host网络需要设置端口转发：\n-p 53:53/udp \\\n-p 53:53/tcp \\\n")])])]),a("p",[e._v("23.10jail的如果53端口被占用，要停用myjail容器内systemd-resolved服务。")]),e._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("systemctl disable systemd-resolved.service\nsystemctl stop systemd-resolved.service\n")])])]),a("p",[e._v("需要新建smartdns.conf，具体配置请参考"),a("a",{attrs:{href:"https://link.zhihu.com/?target=https%3A//pymumu.github.io/smartdns/config/basic-config/",target:"_blank",rel:"noopener noreferrer"}},[e._v("smartdns文档"),a("OutboundLink")],1),e._v("。")]),e._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("# 懒得折腾就在文件末加上阿里dns和dnspod的doh地址。\n# smartdns不能解决dns投毒。\nserver-https https://223.5.5.5/dns-query\nserver-https https://1.12.12.12/dns-query\n")])])]),a("h3",{attrs:{id:"部署syncthing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署syncthing"}},[e._v("#")]),e._v(" 部署syncthing")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("sudo docker run -d  \\\n    --name=syncthing  \\\n    --hostname=truenas-syncthing  \\\n    --network=host  \\\n    -e PUID=3000 \\\n    -e PGID=3000 \\\n    -v /mnt/config/syncthing:/var/syncthing  \\\n    -v /mnt/tongbu:/var/syncthing/sync  \\\n    syncthing/syncthing:latest\n\n\n#不用host网络需要设置端口转发\n#-p 8384:8384 -p 22000:22000/tcp -p 22000:22000/udp -p 21027:21027/udp\n")])])]),a("h3",{attrs:{id:"部署cf-ddns"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署cf-ddns"}},[e._v("#")]),e._v(" 部署cf-ddns")]),e._v(" "),a("p",[e._v("在前文--bind='/mnt/jingxiang1/docker/myjail:/home' ，挂载为运行docker的容器内的/home目录下新建cfddns文件夹，")]),e._v(" "),a("p",[e._v("新建docker-compose.yml文件：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("version: '3.9'\nservices:\n  cloudflare-ddns:\n    image: timothyjmiller/cloudflare-ddns:latest\n    container_name: cloudflare-ddns\n    security_opt:\n      - no-new-privileges:true\n    network_mode: 'host'\n    environment:\n      - PUID=1000\n      - PGID=1000\n    volumes:\n      - /home/cfddns/config.json:/config.json\n    restart: unless-stopped\n")])])]),a("p",[e._v("新建config.json文件，通常只需要配置：")]),e._v(" "),a("p",[e._v("api_token，在cf控制台，右上角的账户，我的个人资料，API令牌，创建令牌，编辑区域DNS模板。")]),e._v(" "),a("blockquote",[a("p",[e._v("既：权限-区域-DNS-编辑，区域资源既包括ddns的域名。")]),e._v(" "),a("p",[e._v("配置api_token后不需要配置api_key。")])]),e._v(" "),a("p",[e._v("zone_id，cf控制台-网站，点击要配置ddns的域名，右下角的区域ID既zone_id。")]),e._v(" "),a("p",[e._v("name既配置二级域名。如果要配置二级域名，先要在cf控制台建立该条目。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('{\n  "cloudflare": [\n    {\n      "authentication": {\n        "api_token": "api_token_here", // Either api_token or api_key\n        "api_key": {\n          "api_key": "",\n          "account_email": ""\n        }\n      },\n      "zone_id": "your_zone_id_here",\n      "subdomains": [\n        {\n          "name": "", // Root domain (example.com)\n          "proxied": false\n        },\n        {\n          "name": "foo", // (foo.example.com)\n          "proxied": false\n        },\n        {\n          "name": "bar", // (bar.example.com)\n          "proxied": false\n        }\n      ]\n    }\n  ],\n  "a": true, // true既更新ipv4\n  "aaaa": true, // true既更新ipv6\n  "purgeUnknownRecords": false,\n  "ttl": 300\n}\n')])])]),a("h3",{attrs:{id:"部署wiregard-easy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署wiregard-easy"}},[e._v("#")]),e._v(" 部署wiregard-easy")]),e._v(" "),a("p",[e._v("能拉到公网IP可以不部署headscale或zerotier，都用的wireguard协议。只需要配置好ddns域名，并在路由器设置端口转发，然后docker运行wg-easy即可连接内网。其运行逻辑类似于部署服务端，被动等待被连接，可以生成二维码或配置文件在客户端一键导入。")]),e._v(" "),a("blockquote",[a("p",[e._v("openwrt打开ipv6端口，或openwrt下wireguard组网请"),a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/683091761",target:"_blank",rel:"noopener noreferrer"}},[e._v("参考"),a("OutboundLink")],1),e._v("。")])]),e._v(" "),a("p",[e._v("wireguard每个节点都要设置其他节点的公钥，如果不填对方的节点地址（ip或动态域名）就类似于服务端，被动等待连接，填了可以主动发起连接也可以等着被连接。")]),e._v(" "),a("p",[e._v("需要mesh组网，可以考虑headscale或zerotier自建moon，最好有公网服务器，也可以考虑netmaker。会自动配置各节点。")]),e._v(" "),a("p",[e._v("如果打算直接用wireguard配置mesh网络，可以考虑用"),a("a",{attrs:{href:"https://link.zhihu.com/?target=https%3A//github.com/k4yt3x/wg-meshconf",target:"_blank",rel:"noopener noreferrer"}},[e._v("wg-meshconf"),a("OutboundLink")],1),e._v("。一键生成各个节点的配置文件，但是一个个节点改还是挺麻烦的。")]),e._v(" "),a("blockquote",[a("p",[e._v("如果遇到高峰期丢包，可以考虑增加一层phantun或udp2raw，混淆UDP数据包。")])]),e._v(" "),a("p",[e._v("docker运行wg-easy需要宿主机内核支持wireguard。")]),e._v(" "),a("p",[e._v("修改-e WG_PORT=51820端口是修改wg-easy生成给客户端的配置文件的端口号，其脚本写死51820端口，修改wg服务端口不能用host网络，只能用bridge网络修改转发的物理机端口号。")]),e._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('sudo docker run -d \\\n  --name=wg-easy \\\n  -e LANG=chs \\\n  -e WG_HOST=IP或ddns域名 \\\n  -e PASSWORD=控制台密码 \\\n  -v /mnt/config/wg-easy:/etc/wireguard \\\n  --network=host  \\\n  --cap-add=NET_ADMIN \\\n  --cap-add=SYS_MODULE \\\n  --restart unless-stopped \\\n  ghcr.io/wg-easy/wg-easy\n  \n不用host，需要配置端口转发：51820用于虚拟组网，51821用于web控制台。\n  --sysctl="net.ipv4.conf.all.src_valid_mark=1" \\\n  --sysctl="net.ipv4.ip_forward=1" \\\n  -p 51820:51820/udp \\\n  -p 51821:51821/tcp \\\n\n\n  -e WG_PORT=51820 \\ 可以修改wg服务端口\n  -e PORT=51821 \\ 可以修改web控制台端口\n')])])]),a("h3",{attrs:{id:"相册对比"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#相册对比"}},[e._v("#")]),e._v(" 相册对比")]),e._v(" "),a("p",[e._v("immich是作为一个相册备份软件所设计。上传文件目录按时间放置，保持原文件名，交互性易用性我觉得是最好的，支持jxl，长图虽然没有适配，不过好赖滚轮能放大。")]),e._v(" "),a("blockquote",[a("p",[e._v("immich挂载本地目录需要在administration-users当中设置允许用户访问的外部目录，再到登录的用户设置-libraries中设置外部库的目录，才能索引，immich对外部库不会写入只会读取。")])]),e._v(" "),a("p",[e._v("immich手机端软件删除则服务端和本地一起删，手机相册删除只删本地。其他设备或网页端删除则只在服务端删除，手机端会再次上传。")]),e._v(" "),a("p",[e._v("photoview没有上传，同步等功能，有深度学习分类。不支持jxl，没有适配长图，但还是可以查看原图放大了看。视频文件点两下才开始播放。对内嵌预览的dng文件正常显示。")]),e._v(" "),a("p",[e._v("librephoto像是更重的photoview，有深度学习分类，兼容jxl，长图显示预览图糊成一片，dng文件不读取内嵌预览，瞎生成，没有适配视频。")]),e._v(" "),a("p",[e._v("photoprism作为一个相册功能算是齐全的，本地挂载正常索引，上传文件位置按相册放置，会按时间重命名。视频兼容性不错，没有长图适配，想放大了看都看不了。只有上传的dng算dng，本地挂载的dng索引后只有内嵌的jpg预览。")]),e._v(" "),a("p",[e._v("lychee会把文件重命名成md5码，目录也会打乱，更像是图床。有点呆。")]),e._v(" "),a("p",[e._v("piwigo的移动端没有同步功能，要批量选中后上传。只兼容jpg，gif，png。非常呆。")]),e._v(" "),a("p",[e._v("可道云，本地挂载要修改目录权限为775。适配长图。不兼容dng，jxl。app相册同步无视dng。缩略图只会生成小图。")]),e._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("id nginx\nchown -R 101:101 /mnt/dcim &amp;&amp; chmod -R 775  /mnt/dcim\n")])])])])}),[],!1,null,null,null);t.default=r.exports}}]);